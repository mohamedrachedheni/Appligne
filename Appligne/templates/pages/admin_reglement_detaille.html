{% extends 'base.html' %}
{% load static %}
{% block title %} | Détail accord règlement{% endblock %}

{% block content %}

    <div class="row ">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 sidebar-container bg-light">
            {% if request.user.is_authenticated and request.user.is_staff and request.user.is_active %}
                {% include 'partials/_sidebar_admin.html' %}
            {% else %}
                {% include 'partials/_sidebar.html' %}
            {% endif %}
        </div>

        <!-- Main Content -->
        <main class="col-md-9 col-lg-10 ">
            <div class="container-fluid py-4">
                <!-- Header Section -->
                <div class="container">
                    <h1 class="page-title text-center text-primary">
                        <i class="fas fa-file-contract me-2"></i>Détails de l'accord de règlement
                    </h1>
                    <p class="text-muted text-center">Consultation des détails du règlement pour le professeur</p>
                </div>

                <!-- Alerts Section -->
                <div class="row">
                    <div class="col-12">
                        {% include 'partials/_alerts.html' %}
                    </div>
                </div>

                <!-- Accord Details Form -->
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}

                    {% if request.user.is_authenticated and request.user.is_active %}
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-info-circle text-primary me-2"></i>Informations générales
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <!-- Admin Info -->
                                <div class="col-md-6 col-lg-3">
                                    <div class="form-group">
                                        <label class="form-label fw-bold">Administrateur</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-user-shield"></i></span>
                                            <input type="text" class="form-control" value="{{accord_reglement.admin_user.first_name}}" readonly>
                                        </div>
                                    </div>
                                </div>

                                <!-- Professor Info -->
                                <div class="col-md-6 col-lg-3">
                                    <div class="form-group">
                                        <label class="form-label fw-bold">Professeur</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-chalkboard-teacher"></i></span>
                                            <input type="text" class="form-control" value="{{accord_reglement.professeur.user.first_name}} {{accord_reglement.professeur.user.last_name}}" readonly>
                                        </div>
                                    </div>
                                </div>

                                <!-- Status -->
                                <div class="col-md-6 col-lg-2">
                                    <div class="form-group">
                                        <label class="form-label fw-bold">Statut</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                {% if accord_reglement.status == 'Réalisé' %}
                                                    <i class="fas fa-check-circle text-success"></i>
                                                {% else %}
                                                    <i class="fas fa-clock text-warning"></i>
                                                {% endif %}
                                            </span>
                                            <input type="text" class="form-control" value="{{accord_reglement.status}}" readonly>
                                        </div>
                                    </div>
                                </div>

                                <!-- Total Amount -->
                                <div class="col-md-6 col-lg-2">
                                    <div class="form-group">
                                        <label class="form-label fw-bold">Montant total</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-euro-sign"></i></span>
                                            <input type="text" class="form-control" value="{{accord_reglement.total_amount|default:'0.00'|floatformat:2}} €" readonly>
                                        </div>
                                    </div>
                                </div>

                                <!-- Due Date -->
                                <div class="col-md-6 col-lg-2">
                                    <div class="form-group">
                                        <label class="form-label fw-bold">Échéance</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-calendar-day"></i></span>
                                            <input type="text" class="form-control" value="{{accord_reglement.due_date|date:'d/m/Y'}}" readonly>
                                        </div>
                                    </div>
                                </div>

                                <!-- Transfer Info -->
                                <div class="col-md-6 col-lg-2">
                                    <div class="form-group">
                                        <label class="form-label fw-bold">Transfert</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-exchange-alt"></i></span>
                                            <input type="text" class="form-control" 
                                                {% if accord_reglement.date_trensfere %} 
                                                    value="{{accord_reglement.date_trensfere|date:'d/m/Y'}} (ID: {{accord_reglement.transfere_id}})" 
                                                {% else %} 
                                                    value="Non transféré" 
                                                {% endif %} 
                                                readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Details Section -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-list-ul text-primary me-2"></i>Détail des éléments
                            </h5>
                        </div>
                        <div class="card-body">
                            {% for id, description, professor_share, reclamation in detaille %}
                            <div class="row g-3 mb-3 align-items-center">
                                <!-- Description -->
                                <div class="col-md-8">
                                    <div class="form-group">
                                        <label class="form-label">Description</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-align-left"></i></span>
                                            <input type="text" class="form-control" value="{{description}}" readonly>
                                        </div>
                                    </div>
                                </div>

                                <!-- Amount and Action -->
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">Montant à régler</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-euro-sign"></i></span>
                                            <input type="text" class="form-control" value="{{professor_share|default:'0.00'|floatformat:2}} €" readonly>
                                            <button type="submit" class="btn {% if not reclamation %}btn-primary{% else %}btn-danger{% endif %}" name="btn_paiement_id{{id}}">
                                                {% if not reclamation %}
                                                    <i class="fas fa-search me-1"></i>Détail
                                                {% else %}
                                                    <i class="fas fa-exclamation-triangle me-1"></i>Contesté
                                                {% endif %}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Message Section -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-envelope text-primary me-2"></i>Message associé
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <textarea class="form-control message-content" rows="4" readonly>{{texte_email}}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    {% if request.user.is_authenticated and request.user.is_active and request.user.is_staff  and request.user.is_active %}
                    <div class="row ">
                        <div class="col-md-6 col-sm-12 d-grid gap-2 d-flex justify-content-center ">
                            <button type="submit" class="btn btn-warning" name="btn_modification" {% if accord_reglement.status == 'Réalisé' or accord_reglement.status == 'Annulé' %}disabled{% endif %} >
                                <i class="fas fa-edit me-1"></i>Passer à la modification de l'accord
                            </button>
                        </div>
                        <div class=" col-md-6 col-sm-12 d-grid gap-2 d-flex justify-content-center ">
                            <button type="submit" class="btn btn-warning" name="btn_detaille_reglement" {% if not accord_reglement.status == 'En attente' %}disabled{% endif %} >
                                <i class="fas fa-edit me-1"></i>Passer au règlement
                            </button>
                        </div>
                    </div>
                    
                    {% endif %}
                    {% endif %}
                </form>
            </div>
        </main>
    </div>


<!-- Back to Top Button -->
<a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top">
    <i class="fas fa-arrow-up"></i>
</a>
{% endblock %}

{% block javascript %}
<script>
// Function to adjust textarea height based on content
function adjustTextareaHeight() {
    const textareas = document.querySelectorAll('.message-content');
    
    textareas.forEach(textarea => {
        textarea.style.height = 'auto';
        textarea.style.height = (textarea.scrollHeight) + 'px';
    });
}

// Initialize on load and on content changes
window.addEventListener('load', adjustTextareaHeight);
document.addEventListener('input', adjustTextareaHeight);
</script>
{% endblock %}