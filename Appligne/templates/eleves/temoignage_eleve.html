{% extends 'base.html' %}
{% load static %}
{% block title %} | Témoignage{% endblock %}

{% block head %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'css/styleplus_temoignage.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        .sidebar-column {
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            background-color: #f8f9fa;
        }
        .main-content-column {
            overflow-x: hidden;
            padding: 2rem;
        }
        .rating-star {
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.2s;
        }
        .rating-star:hover {
            transform: scale(1.1);
        }
        @media (max-width: 767.98px) {
            .sidebar-column {
                height: auto;
                position: relative;
            }
            .main-content-column {
                padding: 1rem;
            }
        }
    </style>
{% endblock %}

{% block content %}

    <div class="row justify-content-center">
            <div class="col-sm-12 col-md-4 col-lg-2  ">
                {% include 'partials/_sidebar_eleve.html' %}
            </div>
            
            <div class=" col-sm-12 col-md-8 col-lg-10  wow fadeInUp py-5  " data-wow-delay="0.1s">
                <div class="container-xxl py-1" >
                    <div class="container  ">
                        <div class="text-center wow fadeInUp py-4 " data-wow-delay="0.1s"
                            style="visibility: visible; animation-delay: 0.1s; animation-name: fadeInUp;">
                            <h3 class="section-title bg-white text-center text-primary px-3 mb-4">Témoignage et évaluation</h3>
                        </div>
                        <div class="col-md-12">
                            {% include 'partials/_alerts.html' %}
                        </div>
                    </div>
                </div>

                <!-- Testimonial Form -->
                <form method="POST" enctype="multipart/form-data" autocomplete="off" class="needs-validation" novalidate>
                    {% csrf_token %}
                    <div class="container-xxl py-5">
                        <div class="container">
                            <div class="container bg-light py-5 " >
                                <div class="row justify-content-center mx-0  "  >  <!-- mx-0 pour supprimer les marges horizontales -->
                                    <div class="col-12 col-xl-10 col-lg-11 px-2 px-md-3">  <!-- Padding réduit et responsive -->
                                        <div class="card border-0 shadow-sm rounded-3">
                                            <div class="card-body p-3 p-md-4">  <!-- Padding réduit sur mobile -->
                                                <!-- Professor Selection -->
                                                <div class="mb-4">
                                                    <label for="prof_id" class="form-label fw-semibold">Sélectionnez un professeur :</label>
                                                    <select class="form-select shadow-none" id="prof_id" name="prof" required>
                                                        <option value="" disabled selected>Choisir un professeur...</option>
                                                        {% for prof in list_prof %}
                                                        <option value="{{ prof.id }}" {% if selected_prof == prof.id|stringformat:"s" %}selected{% endif %}>
                                                            {{ prof.last_name|upper }} {{ prof.first_name }} • Tél: {{ prof.professeur.numero_telephone }}
                                                        </option>
                                                        {% endfor %}
                                                    </select>
                                                    <div class="invalid-feedback">
                                                        Veuillez sélectionner un professeur.
                                                    </div>
                                                </div>

                                                <!-- Star Rating -->
                                                <div class="mb-4">
                                                    <label class="form-label fw-semibold d-block">Évaluation :</label>
                                                    <div class="star-rating mb-2">
                                                        {% for i in "12345" %}
                                                            <i class="fas fa-star rating-star text-muted" id="star{{i}}" data-rating="{{i}}"></i>
                                                        {% endfor %}
                                                        <span class="rating-text ms-2 fw-medium" id="rating-text">Sélectionnez une note</span>
                                                    </div>
                                                    <input type="hidden" name="temoignage" id="temoignage-value" value="{{selected_temoignage}}" required>
                                                </div>

                                                <!-- Testimonial Content -->
                                                <div class="mb-4">
                                                    <label for="text_email_id" class="form-label fw-semibold">Votre témoignage :</label>
                                                    <textarea class="form-control shadow-none auto-resize" id="text_email_id" rows="5" name="text" maxlength="300" 
                                                            placeholder="Décrivez votre expérience avec ce professeur (300 caractères max)..." 
                                                            required>{{ selected_text|default_if_none:'' }}</textarea>
                                                    <div class="d-flex justify-content-between mt-1">
                                                        <div class="invalid-feedback">
                                                            Veuillez rédiger votre témoignage.
                                                        </div>
                                                        <div class="form-text">
                                                            <span id="char-count">0</span>/300 caractères
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Form Buttons -->
                                                <div class="d-flex justify-content-between mt-4">
                                                    <a href="{% url 'compte_eleve' %}" class="btn btn-outline-primary px-3 px-md-4">  <!-- Padding réduit sur mobile -->
                                                        <i class="fas fa-arrow-left me-2"></i>Retour au compte
                                                    </a>
                                                    <button type="submit" class="btn btn-primary px-3 px-md-4" name="btn_enr">  <!-- Padding réduit sur mobile -->
                                                        <i class="fas fa-save me-2"></i>Enregistrer
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Back to Top Button -->
<button class="btn btn-primary btn-floating btn-lg back-to-top animate__animated animate__fadeIn">
    <i class="fas fa-arrow-up"></i>
</button>

{% endblock %}

{% block javascript %}
<script>
    // Textarea Auto-Resize Function
    function adjustTextareaHeight() {
        document.querySelectorAll('.auto-resize').forEach(textarea => {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        });
    }

    // Character Counter
    function updateCharCount() {
        const textarea = document.getElementById('text_email_id');
        const counter = document.getElementById('char-count');
        counter.textContent = textarea.value.length;
    }

    // Star Rating System
    function setupStarRating() {
        const stars = document.querySelectorAll('.rating-star');
        const ratingInput = document.getElementById('temoignage-value');
        const ratingText = document.getElementById('rating-text');
        
        const ratingTexts = [
            "Très déçu",
            "Déçu",
            "Satisfait",
            "Très satisfait",
            "Excellent"
        ];

        stars.forEach(star => {
            star.addEventListener('click', function() {
                const rating = this.getAttribute('data-rating');
                ratingInput.value = rating;
                
                // Update stars display
                stars.forEach((s, index) => {
                    if (index < rating) {
                        s.classList.add('text-warning');
                        s.classList.remove('text-muted');
                    } else {
                        s.classList.add('text-muted');
                        s.classList.remove('text-warning');
                    }
                });
                
                // Update rating text
                ratingText.textContent = ratingTexts[rating-1];
            });

            // Hover effect
            star.addEventListener('mouseenter', function() {
                const hoverRating = this.getAttribute('data-rating');
                stars.forEach((s, index) => {
                    if (index < hoverRating) {
                        s.classList.add('text-warning');
                    } else {
                        s.classList.remove('text-warning');
                    }
                });
            });

            star.addEventListener('mouseleave', function() {
                const currentRating = ratingInput.value || 0;
                stars.forEach((s, index) => {
                    if (index < currentRating) {
                        s.classList.add('text-warning');
                    } else {
                        s.classList.add('text-muted');
                        s.classList.remove('text-warning');
                    }
                });
            });
        });

        // Initialize stars if value exists
        if (ratingInput.value) {
            stars[ratingInput.value-1].click();
        }
    }

    // Form Validation
    (function() {
        'use strict';
        window.addEventListener('load', function() {
            // Initialize components
            adjustTextareaHeight();
            updateCharCount();
            setupStarRating();

            // Form validation
            const forms = document.getElementsByClassName('needs-validation');
            Array.prototype.filter.call(forms, function(form) {
                form.addEventListener('submit', function(event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    })();

    // Event Listeners
    document.getElementById('text_email_id').addEventListener('input', function() {
        adjustTextareaHeight();
        updateCharCount();
    });

    // Back to top button
    document.querySelector('.back-to-top').addEventListener('click', function(e) {
        e.preventDefault();
        window.scrollTo({top: 0, behavior: 'smooth'});
    });
</script>
{% endblock %}