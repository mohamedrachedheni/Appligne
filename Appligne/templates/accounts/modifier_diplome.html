{% extends 'base.html' %}
{% load static %}
{% block title %} | Compte professeur{% endblock %}

{% block content %}

<style>
    :root {
        --primary-color: #4361ee;
        --secondary-color: #3f37c9;
        --accent-color: #4895ef;
        --light-color: #f8f9fa;
        --dark-color: #212529;
        --success-color: #4cc9f0;
        --border-radius: 8px;
        --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --transition: all 0.3s ease;
    }
    
    .modern-container {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .section-title {
        color: var(--primary-color);
        font-weight: 700;
        margin-bottom: 0.5rem;
        font-size: 1.8rem;
    }
    
    .section-subtitle {
        color: #6c757d;
        margin-bottom: 2rem;
        font-size: 1.1rem;
    }
    
    .diplome-card {
        background: var(--light-color);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-left: 4px solid var(--accent-color);
        transition: var(--transition);
    }
    
    .diplome-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--box-shadow);
    }
    
    .form-control-modern {
        border-radius: var(--border-radius);
        padding: 0.75rem 1rem;
        border: 1px solid #dee2e6;
        transition: var(--transition);
    }
    
    .form-control-modern:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.15);
    }
    
    .btn-modern {
        border-radius: var(--border-radius);
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        transition: var(--transition);
    }
    
    .btn-primary-modern {
        background: var(--primary-color);
        border: none;
    }
    
    .btn-primary-modern:hover {
        background: var(--secondary-color);
        transform: translateY(-2px);
    }
    
    .btn-warning-modern {
        background: #ff9e00;
        border: none;
        color: white;
    }
    
    .btn-warning-modern:hover {
        background: #ff9700;
        transform: translateY(-2px);
    }
    
    .btn-outline-modern {
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        background: transparent;
    }
    
    .btn-outline-modern:hover {
        background: var(--primary-color);
        color: white;
    }
    
    .delete-btn {
        background: transparent;
        border: none;
        color: #dc3545;
        padding: 0.5rem;
        border-radius: 50%;
        transition: var(--transition);
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .delete-btn:hover {
        background: rgba(220, 53, 69, 0.1);
        transform: scale(1.05);
    }
    
    .custom-checkbox {
        display: flex;
        align-items: center;
    }
    
    .custom-checkbox .form-check-input {
        width: 1.2rem;
        height: 1.2rem;
        margin-right: 0.5rem;
    }
    
    .custom-checkbox .form-check-input:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .custom-checkbox label {
        font-weight: 500;
        margin-bottom: 0;
        cursor: pointer;
    }
    
    .dropdown-menu {
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        border: none;
        padding: 0.5rem;
    }
    
    .dropdown-item {
        padding: 0.5rem 1rem;
        border-radius: 4px;
        transition: var(--transition);
    }
    
    .dropdown-item:hover {
        background: #e9ecef;
    }
    
    /* Style pour le calendrier */
    .datepicker-container {
        position: relative;
    }
    
    .datepicker-icon {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        pointer-events: none;
    }
    
    .datepicker {
        background-color: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        padding: 1rem;
        position: absolute;
        z-index: 1000;
        width: 300px;
        display: none;
    }
    
    .datepicker-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .datepicker-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
    }
    
    .datepicker-day {
        padding: 0.5rem;
        text-align: center;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .datepicker-day:hover {
        background-color: #e9ecef;
    }
    
    .datepicker-day.selected {
        background-color: var(--primary-color);
        color: white;
    }
    
    .datepicker-day.other-month {
        color: #6c757d;
    }
    
    .datepicker-today {
        background-color: #f8f9fa;
        font-weight: bold;
    }
    
    /* Correction pour l'alignement horizontal des jours de la semaine */
    .weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        margin-bottom: 0.5rem;
        text-align: center;
        font-weight: 600;
    }
    
    @media (max-width: 768px) {
        .diplome-card {
            padding: 1rem;
        }
        
        .btn-modern {
            width: 100%;
            margin-bottom: 0.5rem;
        }
        
        .button-group {
            flex-direction: column;
        }
        
        .datepicker {
            width: 280px;
            left: 50%;
            transform: translateX(-50%);
        }
    }
</style>

<!-- mon compte début -->
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-3 col-md-4">
            <!-- début sidebar -->
            {% include 'partials/_sidebar.html' %}
            <!-- fin sidebar -->
        </div>
        
        <div class="col-lg-9 col-md-8">
            <div class="modern-container">
                <div class="text-center mb-5">
                    <h1 class="section-title">Mise à jour de votre profil</h1>
                    <p class="section-subtitle">Modifier vos diplômes</p>
                </div>
                
                <div class="col-12 mb-4">
                    {% include 'partials/_alerts.html' %}
                </div>
                
                <form method="POST" enctype="multipart/form-data" autocomplete="off">
                    {% csrf_token %}
                    
                    <!-- parcours scolaire debut -->
                    <div class="mb-5">
                        <h4 class="mb-4">Vos diplômes</h4>
                        
                        {% for diplome in diplomes %}
                        <div class="diplome-card" id="supprimerDivDiplome_{{ forloop.counter }}">
                            <div class="row">
                                <div class="col-md-1 mb-3">
                                    <div class="custom-checkbox">
                                        <input class="form-check-input" type="checkbox" id="principal_id_{{ forloop.counter }}" name="principal_{{ forloop.counter }}" {% if diplome.principal %}checked{% endif %}>
                                        <label class="form-check-label" for="principal_id_{{ forloop.counter }}">Principal</label>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-semibold">Diplôme</label>
                                    <div class="dropdown">
                                        <div class="input-group">
                                            <input type="text" class="form-control form-control-modern" id="autre_diplome_input_{{ forloop.counter }}" name="diplome_{{ forloop.counter }}" value="{{ diplome.diplome_cathegorie }}">
                                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton_{{ forloop.counter }}" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="fas fa-chevron-down"></i>
                                            </button>
                                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton_{{ forloop.counter }}" style="max-height: 300px; overflow-y:auto;" id="ul_dropdown_{{ forloop.counter }}">
                                                {% for cathegorie in diplome_cathegories %}
                                                <li><a class="dropdown-item" href="#" data-value="{{ cathegorie.dip_cathegorie }}">{{ cathegorie.dip_cathegorie }}</a></li>
                                                {% endfor %}
                                            </ul>
                                            <input type="hidden" id="selected_diplome_{{ forloop.counter }}">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-2 mb-3">
                                    <label for="date_id_{{ forloop.counter }}" class="form-label fw-semibold">Optenu le</label>
                                    <div class="datepicker-container">
                                        <input type="text" class="form-control form-control-modern date-input" id="date_id_{{ forloop.counter }}" required name="date_obtenu_{{ forloop.counter }}" placeholder="Sélectionnez une date" value="{{ diplome.obtenu }}" readonly>
                                        <span class="datepicker-icon"><i class="fas fa-calendar-alt"></i></span>
                                        <div class="datepicker" id="datepicker_{{ forloop.counter }}">
                                            <div class="datepicker-header">
                                                <button type="button" class="btn btn-sm btn-outline-modern prev-year"><i class="fas fa-fast-backward"></i></button>
                                                <button type="button" class="btn btn-sm btn-outline-modern prev-month"><i class="fas fa-chevron-left"></i></button>
                                                <span class="current-month" id="current-month-{{ forloop.counter }}">Mois 2023</span>
                                                <button type="button" class="btn btn-sm btn-outline-modern next-month"><i class="fas fa-chevron-right"></i></button>
                                                <button type="button" class="btn btn-sm btn-outline-modern next-year"><i class="fas fa-fast-forward"></i></button>
                                            </div>
                                            <div class="weekdays">
                                                <div>Lu</div>
                                                <div>Ma</div>
                                                <div>Me</div>
                                                <div>Je</div>
                                                <div>Ve</div>
                                                <div>Sa</div>
                                                <div>Di</div>
                                            </div>
                                            <div class="datepicker-grid" id="date-grid-{{ forloop.counter }}">
                                                <!-- Les jours seront générés par JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="intitule_id_{{ forloop.counter }}" class="form-label fw-semibold">Intitulé</label>
                                    <input type="text" class="form-control form-control-modern" id="intitule_id_{{ forloop.counter }}" name="intitule_{{ forloop.counter }}" value="{{ diplome.intitule }}">
                                </div>
                                
                                <div class="col-md-1 d-flex align-items-end mb-3">
                                    <button type="button" class="delete-btn" onclick="supprimerDiv('supprimerDivDiplome_{{ forloop.counter }}')">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <!-- parcours scolaire fin -->
                    
                    <div class="d-flex flex-wrap justify-content-between gap-3 mt-4 button-group">
                        <a class="btn btn-outline-modern btn-modern" href="{% url 'profil_prof' id_user=user.id %}">
                            <i class="fas fa-eye me-2"></i>Voir votre profil
                        </a>
                        <a class="btn btn-outline-modern btn-modern" href="{% url 'modifier_diplome' %}">
                            <i class="fas fa-times me-2"></i>Annuler
                        </a>
                        <button type="submit" class="btn btn-warning-modern btn-modern" name="btn_enr">
                            <i class="fas fa-save me-2"></i>Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- mon compte fin -->

<!-- Back to Top -->
<a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialisation des calendriers pour chaque champ de date
        document.querySelectorAll('.date-input').forEach(function(input, index) {
            initDatepicker(input, index);
        });
        
        // Gestion des menus déroulants pour les diplômes
        document.querySelectorAll('.dropdown-item').forEach(function(item) {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const value = this.getAttribute('data-value');
                const input = this.closest('.dropdown').querySelector('input[type="text"]');
                input.value = value;
            });
        });
    });
    
    function initDatepicker(input, index) {
        const datepicker = document.getElementById(`datepicker_${index+1}`);
        const dateGrid = document.getElementById(`date-grid-${index+1}`);
        const currentMonthElem = document.getElementById(`current-month-${index+1}`);
        
        let currentDate = new Date();
        let selectedDate = null;
        
        // Vérifier si une date existe déjà
        if (input.value) {
            const parts = input.value.split('/');
            if (parts.length === 3) {
                selectedDate = new Date(parts[2], parts[1] - 1, parts[0]);
            }
        }
        
        // Afficher le calendrier quand on clique sur le champ
        input.addEventListener('click', function() {
            // Masquer tous les autres calendriers
            document.querySelectorAll('.datepicker').forEach(dp => {
                dp.style.display = 'none';
            });
            
            // Afficher ce calendrier
            if (datepicker.style.display === 'none') {
                datepicker.style.display = 'block';
                renderCalendar(currentDate, index);
            } else {
                datepicker.style.display = 'none';
            }
        });
        
        // Navigation du calendrier
        datepicker.querySelector('.prev-year').addEventListener('click', function() {
            currentDate.setFullYear(currentDate.getFullYear() - 1);
            renderCalendar(currentDate, index);
        });
        
        datepicker.querySelector('.prev-month').addEventListener('click', function() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar(currentDate, index);
        });
        
        datepicker.querySelector('.next-month').addEventListener('click', function() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar(currentDate, index);
        });
        
        datepicker.querySelector('.next-year').addEventListener('click', function() {
            currentDate.setFullYear(currentDate.getFullYear() + 1);
            renderCalendar(currentDate, index);
        });
        
        function renderCalendar(date, idx) {
            const year = date.getFullYear();
            const month = date.getMonth();
            
            // Mettre à jour l'en-tête du calendrier
            const monthNames = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin",
                "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"
            ];
            currentMonthElem.textContent = `${monthNames[month]} ${year}`;
            
            // Vider la grille
            dateGrid.innerHTML = '';
            
            // Premier jour du mois
            const firstDay = new Date(year, month, 1);
            // Dernier jour du mois
            const lastDay = new Date(year, month + 1, 0);
            
            // Jour de la semaine du premier jour (0 = Dimanche, 1 = Lundi, etc.)
            let firstDayIndex = firstDay.getDay();
            // Ajuster pour que Lundi soit le premier jour (index 0)
            firstDayIndex = firstDayIndex === 0 ? 6 : firstDayIndex - 1;
            
            // Jours du mois précédent
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            
            // Ajouter les jours du mois précédent
            for (let i = 0; i < firstDayIndex; i++) {
                const day = document.createElement('div');
                day.className = 'datepicker-day other-month';
                day.textContent = prevMonthLastDay - firstDayIndex + i + 1;
                dateGrid.appendChild(day);
            }
            
            // Ajouter les jours du mois actuel
            const today = new Date();
            for (let i = 1; i <= lastDay.getDate(); i++) {
                const day = document.createElement('div');
                day.className = 'datepicker-day';
                
                // Vérifier si c'est aujourd'hui
                if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    day.classList.add('datepicker-today');
                }
                
                // Vérifier si c'est la date sélectionnée
                if (selectedDate && i === selectedDate.getDate() && month === selectedDate.getMonth() && year === selectedDate.getFullYear()) {
                    day.classList.add('selected');
                }
                
                day.textContent = i;
                
                day.addEventListener('click', function() {
                    // Mettre à jour la date sélectionnée
                    selectedDate = new Date(year, month, i);
                    
                    // Mettre à jour l'affichage
                    document.querySelectorAll(`#datepicker_${idx+1} .datepicker-day`).forEach(d => {
                        d.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    
                    // Mettre à jour le champ de saisie
                    const formattedDate = `${i.toString().padStart(2, '0')}/${(month + 1).toString().padStart(2, '0')}/${year}`;
                    input.value = formattedDate;
                    
                    // Masquer le calendrier
                    datepicker.style.display = 'none';
                });
                
                dateGrid.appendChild(day);
            }
            
            // Calculer le nombre de cellules restantes
            const totalCells = 42; // 6 lignes de 7 jours
            const remainingCells = totalCells - (firstDayIndex + lastDay.getDate());
            
            // Ajouter les jours du mois suivant
            for (let i = 1; i <= remainingCells; i++) {
                const day = document.createElement('div');
                day.className = 'datepicker-day other-month';
                day.textContent = i;
                dateGrid.appendChild(day);
            }
        }
        
        // Masquer le calendrier quand on clique ailleurs
        document.addEventListener('click', function(e) {
            if (!input.contains(e.target) && !datepicker.contains(e.target)) {
                datepicker.style.display = 'none';
            }
        });
        
        // Initialiser l'affichage du calendrier
        if (selectedDate) {
            currentDate = new Date(selectedDate);
        }
        renderCalendar(currentDate, index);
    }
</script>

{% endblock %}

{% block javascript %}
<script src="{% static 'js/Code_en_plus_modifier_diplome.js' %}"></script>
{% endblock %}