{% extends 'base.html' %}
{% load static %}
{% block title %} | Création d'un nouveau cours{% endblock %}

{% block content %}
<main class="container-fluid">
    <div class="row justify-content-center g-0">
        <!-- Sidebar -->
        <aside class="col-sm-12 col-md-4 col-lg-2">
            {% include 'partials/_sidebar.html' %}
        </aside>

        <!-- Main Content -->
        <section class="col-sm-12 col-md-8 col-lg-10 wow fadeInUp" data-wow-delay="0.1s">
            <!-- Page Header -->
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <header class="text-center mb-4">
                        <h1 class="section-title text-primary mb-3">Enregistrement d'un nouveau cours</h1>
                        {% include 'partials/_alerts.html' %}
                    </header>

                    {% if request.user.is_authenticated %}
                    <form method="POST" enctype="multipart/form-data" autocomplete="off" class="needs-validation" novalidate>
                        {% csrf_token %}

                        <!-- Error Container -->
                        <div id="error-container" class="alert alert-danger mb-3" style="display: none;"></div>
                        
                        <!-- Student Information -->
                        <article class="mb-4 bg-light p-3 rounded-2">
                            <h2 class="h5 mb-3 text-primary">Informations de l'élève</h2>
                            <div class="row g-2">
                                <div class="col-12">
                                    <div class="input-group">
                                        <span class="input-group-text bg-primary text-white">
                                            <i class="fas fa-user-graduate"></i>
                                        </span>
                                        <input type="text" class="form-control-plaintext ps-2" 
                                               value="{{ eleve.user.first_name }} {{ eleve.user.last_name }}" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text bg-primary text-white">
                                            <i class="fas fa-envelope"></i>
                                        </span>
                                        <input type="text" class="form-control-plaintext ps-2" 
                                               value="{{ eleve.user.email }}" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text bg-primary text-white">
                                            <i class="fas fa-phone"></i>
                                        </span>
                                        <input type="text" class="form-control-plaintext ps-2" 
                                               value="{{ eleve.numero_telephone }}" readonly>
                                    </div>
                                </div>
                            </div>
                        </article>

                        <!-- Parent Information -->
                        <article class="mb-4 bg-light p-3 rounded-2">
                            <h2 class="h5 mb-3 text-primary">Informations du parent</h2>
                            <div class="row g-2">
                                <div class="col-12">
                                    <div class="input-group">
                                        <span class="input-group-text bg-primary text-white">
                                            <i class="fas fa-user-friends"></i>
                                        </span>
                                        <input type="text" class="form-control-plaintext ps-2" 
                                               value="{{ parent.nom_parent }} {{ parent.prenom_parent }}" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text bg-primary text-white">
                                            <i class="fas fa-envelope"></i>
                                        </span>
                                        <input type="text" class="form-control-plaintext ps-2" 
                                               value="{{ parent.email_parent }}" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text bg-primary text-white">
                                            <i class="fas fa-phone"></i>
                                        </span>
                                        <input type="text" class="form-control-plaintext ps-2" 
                                               value="{{ parent.telephone_parent }}" readonly>
                                    </div>
                                </div>
                            </div>
                        </article>

                        <!-- Course Details -->
                        <article class="mb-4">
                            <h2 class="h5 mb-3 text-primary">Détails du cours</h2>
                            <div class="row g-3">
                                <!-- Course Format -->
                                <div class="col-md-3">
                                    <label for="format_id" class="form-label fw-semibold">Format du cours</label>
                                    <div class="dropdown">
                                        <input type="text" class="form-control dropdown-toggle border border-gray" 
                                               id="format_id" name="format" required value="{{ format_cours }}" 
                                               data-bs-toggle="dropdown" readonly aria-haspopup="true" aria-expanded="false">
                                        <ul class="dropdown-menu w-100" id="dropdownMenu_format_id" aria-labelledby="format_id">
                                            {% if formats.a_domicile %}
                                            <li><a class="dropdown-item dropdown-item-demande" href="#" data-value="Cours à domicile">
                                                <i class="fas fa-home me-2"></i>Cours à domicile</a></li>
                                            {% endif %}
                                            {% if formats.webcam %}
                                            <li><a class="dropdown-item dropdown-item-demande" href="#" data-value="Cours par webcam">
                                                <i class="fas fa-video me-2"></i>Cours par webcam</a></li>
                                            {% endif %}
                                            {% if formats.stage %}
                                            <li><a class="dropdown-item dropdown-item-demande" href="#" data-value="Stage pendant les vacances">
                                                <i class="fas fa-calendar-alt me-2"></i>Stage pendant les vacances</a></li>
                                            {% endif %}
                                            {% if formats.stage_webcam %}
                                            <li><a class="dropdown-item dropdown-item-demande" href="#" data-value="Stage par webcam">
                                                <i class="fas fa-laptop-house me-2"></i>Stage par webcam</a></li>
                                            {% endif %}
                                        </ul>
                                        <div class="invalid-feedback">Veuillez sélectionner un format.</div>
                                    </div>
                                </div>

                                <!-- Subject -->
                                <div class="col-md-4">
                                    <label for="matiere_id" class="form-label fw-semibold">Matière</label>
                                    <div class="dropdown">
                                        <input type="text" class="form-control dropdown-toggle border border-gray" 
                                               id="matiere_id" name="matiere" required value="{{ matiere_nom }}" 
                                               data-bs-toggle="dropdown" readonly aria-haspopup="true" aria-expanded="false">
                                        <ul class="dropdown-menu w-100" id="dropdownMenu_matiere_id" aria-labelledby="matiere_id">
                                            {% for une_matiere in matieres %}
                                            <li><a class="dropdown-item dropdown-item-demande" href="#" data-value="{{ une_matiere.matiere }}">
                                                <i class="fas fa-book me-2"></i>{{ une_matiere.matiere }}</a></li>
                                            {% endfor %}
                                        </ul>
                                        <div class="invalid-feedback">Veuillez sélectionner une matière.</div>
                                    </div>
                                </div>

                                <!-- Level -->
                                <div class="col-md-3">
                                    <label for="niveau_id" class="form-label fw-semibold">Niveau</label>
                                    <div class="dropdown">
                                        <input type="text" class="form-control dropdown-toggle border border-gray" 
                                               id="niveau_id" name="niveau" required value="{{ niveau_nom }}" 
                                               data-bs-toggle="dropdown" readonly aria-haspopup="true" aria-expanded="false">
                                        <ul class="dropdown-menu w-100" id="dropdownMenu_niveau_id" aria-labelledby="niveau_id">
                                            {% for niveau in niveaux %}
                                            <li><a class="dropdown-item dropdown-item-demande" href="#" data-value="{{ niveau.niveau }}">
                                                <i class="fas fa-graduation-cap me-2"></i>{{ niveau.niveau }}</a></li>
                                            {% endfor %}
                                        </ul>
                                        <div class="invalid-feedback">Veuillez sélectionner un niveau.</div>
                                    </div>
                                </div>

                                <!-- Price -->
                                <div class="col-md-2">
                                    <label for="prix_heure_id" class="form-label fw-semibold">Tarif horaire</label>
                                    <div class="input-group has-validation">
                                        <input type="text" class="form-control text-center prix-heure" 
                                               id="prix_heure_id" name="prix_heure" value="{{prix_heure}}" required readonly>
                                        <span class="input-group-text">€/h</span>
                                        <div class="invalid-feedback">Veuillez vérifier le tarif.</div>
                                    </div>
                                </div>
                            </div>
                        </article>

                        <!-- Session Schedule -->
                        <article class="mb-4">
                            <!-- Existing Session -->
                            <div class="row g-3 mb-3 p-3 border rounded bg-light" id="supprimer_horaire_1">
                                <!-- Date -->
                                <div class="col-lg-2 col-md-4">
                                    <label for="date_id_1" class="form-label fw-semibold">Date</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control form-control-date" id="date_id_1" 
                                               name="date1" value="{{ horaire.date }}" required>
                                        <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                    </div>
                                </div>

                                <!-- Start Time -->
                                <div class="col-lg-2 col-md-4">
                                    <label for="debut1_id" class="form-label fw-semibold">Heure début</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control form-control-heure" id="debut1_id" 
                                               name="debut1" value="{{ horaire.debut }}" placeholder="HH:MM" required>
                                        <span class="input-group-text"><i class="fas fa-clock"></i></span>
                                    </div>
                                </div>

                                <!-- End Time -->
                                <div class="col-lg-2 col-md-4">
                                    <label for="fin1_id" class="form-label fw-semibold">Heure fin</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control form-control-heure" id="fin1_id" 
                                               name="fin1" value="{{ horaire.fin }}" placeholder="HH:MM" required>
                                        <span class="input-group-text"><i class="fas fa-clock"></i></span>
                                    </div>
                                </div>

                                <!-- Session Content -->
                                <div class="col-lg-6">
                                    <div class="row g-2">
                                        <div class="col-lg-7 col-md-6">
                                            <label for="contenu1_id" class="form-label fw-semibold">Contenu de la séance</label>
                                            <input type="text" class="form-control" id="contenu1_id" 
                                                   name="contenu1" value="{{ horaire.contenu }}" required>
                                        </div>
                                        <div class="col-lg-4 col-md-6">
                                            <label for="statut1_id" class="form-label fw-semibold">Statut</label>
                                            <select class="form-select" id="statut1_id" name="statut1" required>
                                                <option value="Réaliser">Réaliser</option>
                                                <option value="En attente">En attente</option>
                                            </select>
                                        </div>
                                        <div class="col-lg-1 col-md-6 d-flex align-items-end">
                                            <button type="button" class="btn btn-outline-danger w-100" onclick="supprimerDiv('supprimer_horaire_1')">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h2 class="h5 mb-0 text-primary">Planning des séances</h2>
                                <button type="button" class="btn btn-sm btn-success" onclick="ajouter_horaire()" id="bouton_ajout_div">
                                    <i class="fas fa-plus-circle me-1"></i>Ajouter une séance
                                </button>
                            </div>
                        </article>

                        <!-- Form Actions -->
                        <article class="border-top pt-3">
                            <div class="d-flex flex-wrap justify-content-between gap-2">
                                <button type="submit" class="btn btn-primary flex-grow-1" name="btn_enr">
                                    <i class="fas fa-file-invoice-dollar me-2"></i>Demande de règlement
                                </button>
                                <button type="submit" class="btn btn-info flex-grow-1" name="btn_horaires">
                                    <i class="fas fa-calendar-plus me-2"></i>Planifier des séances
                                </button>
                                <button type="submit" class="btn btn-secondary flex-grow-1" name="btn_cours_planifier">
                                    <i class="fas fa-tasks me-2"></i>Statut des cours
                                </button>
                            </div>
                        </article>
                    </form>
                    {% endif %}
                </div>
            </div>
        </section>
    </div>
</main>

<!-- Back to Top Button -->
<a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top position-fixed bottom-0 end-0 mb-4 me-4">
    <i class="fas fa-arrow-up"></i>
</a>

<!-- Modèle caché pour clonage (ne sera jamais affiché tel quel) -->
<div id="horaire-template" class="row ajout-horaire g-3 mb-4 p-3 border rounded bg-light d-none">
    <div class="col-lg-2 col-md-4">
        <label  class="form-label fw-semibold">Date</label>
        <div class="input-group">
            <input type="text" class="form-control form-control-date"  
                     required>
            <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
        </div>
    </div>
    <div class="col-lg-2 col-md-4">
        <label  class="form-label fw-semibold">Heure début</label>
        <input type="text" class="form-control form-control-heure" placeholder="HH:MM" required>
    </div>
    
    <div class="col-lg-2 col-md-4">
        <label class="form-label fw-semibold">Heure fin</label>
        <input type="text" class="form-control form-control-heure" placeholder="HH:MM" required>
    </div>
    <div class="col-lg-6">
        <div class="row g-2">
            <div class="col-lg-7 col-md-6">
                <label class="form-label fw-semibold">Contenu de la séance</label>
                <input type="text" class="form-control" required>
            </div>
            <div class="col-lg-4 col-md-6">
                <label class="form-label fw-semibold">Statut</label>
                <select class="form-select" required>
                    <option value="Réaliser">Réaliser</option>
                    <option value="En attente">En attente</option>
                </select>
            </div>
            <div class="col-lg-1 col-md-6 d-flex align-items-end">
                <button type="button" class="btn btn-outline-danger btn-supprimer">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascript %}
<!-- JavaScript remains largely the same but better organized -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pikaday/1.8.0/pikaday.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/inputmask/5.0.6/jquery.inputmask.min.js"></script>

<script>
// Main JavaScript code would go here
// Better organized with modules and proper error handling
</script>

<script>
    // Enhanced dropdown functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize dropdowns
        const initDropdown = (inputId, menuId) => {
            const input = document.getElementById(inputId);
            const menu = document.getElementById(menuId);
            
            input.addEventListener('click', (e) => {
                e.stopPropagation();
                menu.style.display = 'block';
            });
            
            document.addEventListener('click', () => {
                menu.style.display = 'none';
            });
            
            const items = menu.querySelectorAll('.dropdown-item-demande');
            items.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    input.value = item.getAttribute('data-value');
                    menu.style.display = 'none';
                    
                    // Trigger change event after selection
                    const event = new Event('change');
                    input.dispatchEvent(event);
                });
            });
        };
        
        initDropdown('format_id', 'dropdownMenu_format_id');
        initDropdown('matiere_id', 'dropdownMenu_matiere_id');
        initDropdown('niveau_id', 'dropdownMenu_niveau_id');

        // Add event listeners for price updates
        document.getElementById('format_id').addEventListener('change', updatePrixFromSelections);
        document.getElementById('matiere_id').addEventListener('change', updatePrixFromSelections);
        document.getElementById('niveau_id').addEventListener('change', updatePrixFromSelections);

        // Single checkbox selection
        const checkboxes = document.querySelectorAll('.form-check-input');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                checkboxes.forEach(cb => {
                    if (cb !== checkbox) cb.checked = false;
                });
            });
        });

        // Date picker initialization
        const initDatePickers = () => {
            const dateInputs = document.querySelectorAll('.form-control-date');
            
            dateInputs.forEach((input) => {
                let ignoreNextBlur = false;
                
                const picker = new Pikaday({
                    field: input,
                    format: 'DD/MM/YYYY',
                    i18n: {
                        previousMonth: 'Mois précédent',
                        nextMonth: 'Mois suivant',
                        months: ['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'],
                        weekdays: ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'],
                        weekdaysShort: ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam']
                    },
                    onSelect: function(date) {
                        // Formatage en jj/mm/aaaa
                        const jour = String(date.getDate()).padStart(2, '0');
                        const mois = String(date.getMonth() + 1).padStart(2, '0');
                        input.value = `${jour}/${mois}/${date.getFullYear()}`;
                        
                        // Activer le flag pour ignorer le prochain blur
                        ignoreNextBlur = true;
                        
                        // Remettre le focus après un léger délai
                        setTimeout(() => {
                            input.focus();
                            input.select();
                        }, 10);
                    },
                    onClose: function() {
                        // Désactiver le flag après un court délai
                        setTimeout(() => {
                            ignoreNextBlur = false;
                        }, 100);
                    }
                });

                // Gestion du blur
                input.addEventListener('blur', function(e) {
                    if (ignoreNextBlur) {
                        e.preventDefault();
                        e.stopPropagation();
                        setTimeout(() => {
                            this.focus();
                        }, 10);
                    }
                });
            });
        };

        // Initialisation
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initDatePickers);
        } else {
            initDatePickers();
        }

        // Time input validation
        const timeInputs = document.querySelectorAll('.form-control-heure');
        timeInputs.forEach(input => {
            Inputmask("99:99", {
                placeholder: "HH:MM",
                insertMode: false,
                showMaskOnHover: false
            }).mask(input);

            input.addEventListener('blur', function() {
                const timeValue = this.value;
                if (timeValue && !/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(timeValue)) {
                    this.classList.add('is-invalid');
                } else {
                    this.classList.remove('is-invalid');
                }
            });
        });

        // Price input formatting
        $('.prix-heure').inputmask({
            alias: 'decimal',
            groupSeparator: '',
            digits: 2,          // 2 chiffres après la virgule
            digitsOptional: false,
            integerDigits: 3,   // Maximum 3 chiffres avant la virgule
            placeholder: '0',
            autoUnmask: true,
            allowMinus: false,
            rightAlign: false,
            max: 999.99         // Valeur maximale autorisée
        });
    });


    





    
</script>
<script>
    // Fonction utilitaire pour afficher des notifications (optionnelle)
    function showToast({type, message, duration = 3000}) {
        // Implémentation basique - à adapter selon votre UI
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.remove(), duration);
    }
</script>

<script>
    
    /**
     * Récupère la valeur d'un cookie par son nom
     * @param {string} name - Nom du cookie à récupérer
     * @returns {string|null} Valeur du cookie ou null si non trouvé
     */
    function getCookie(name) {
        try {
            if (!document.cookie) {
                console.debug('Aucun cookie disponible');
                return null;
            }

            const cookies = document.cookie.split(';');
            console.debug(`Recherche du cookie "${name}" parmi ${cookies.length} cookies`);

            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(`${name}=`)) {
                    const value = decodeURIComponent(cookie.substring(name.length + 1));
                    console.debug(`Cookie "${name}" trouvé`, {value});
                    return value;
                }
            }

            console.warn(`Cookie "${name}" non trouvé`);
            return null;
        } catch (error) {
            console.error('Erreur lors de la récupération du cookie:', error);
            return null;
        }
    }
</script>
<script>
    
    /**
     * Ajoute un nouveau bloc horaire dynamiquement en clonant le template
     */
    function ajouter_horaire() {
        console.groupCollapsed(`Ajout d'un nouvel horaire #${compteurHoraire + 1}`);
        
        try {
            // Récupération du template et création du clone
            const template = document.getElementById('horaire-template');
            if (!template) {
                throw new Error('Template horaire introuvable');
            }
            
            const clone = template.cloneNode(true);
            compteurHoraire += 1;
            console.debug(`Nouvel index horaire: ${compteurHoraire}`);

            // Configuration de l'ID et affichage du clone
            const cloneId = `supprimer_horaire_${compteurHoraire}`;
            clone.classList.remove('d-none');
            clone.id = cloneId;
            console.debug(`ID du nouvel élément: ${cloneId}`);

            // Traitement de tous les éléments input, select et label
            console.debug('Début de la configuration des champs...');
            const inputs = clone.querySelectorAll('input, select, label');
            inputs.forEach((el) => {
                // Configuration des inputs
                if (el.tagName === 'INPUT') {
                    el.value = ''; // Réinitialisation de la valeur
                    
                    // Gestion spécifique des champs date
                    if (el.classList.contains('form-control-date')) {
                        el.name = `date${compteurHoraire}`;
                        el.id = `date_id_${compteurHoraire}`;
                        console.debug(`Champ date configuré: name=${el.name}, id=${el.id}`);
                    }
                    
                    // Gestion spécifique des champs heure
                    if (el.classList.contains('form-control-heure')) {
                        const labelText = el.previousElementSibling?.innerText.trim().toLowerCase();

                        let type = "heure"; // fallback
                        if (labelText.includes("début") || labelText.includes("debut")) {
                            type = "debut";
                        } else if (labelText.includes("fin")) {
                            type = "fin";
                        }

                        el.name = `${type}${compteurHoraire}`;
                        el.id = `${type}${compteurHoraire}_id`;
                        console.debug(`Champ heure (${type}) configuré: name=${el.name}, id=${el.id}`);
                    }
                }

                // Configuration des selects
                if (el.tagName === 'SELECT') {
                    el.name = `statut${compteurHoraire}`;
                    el.id = `statut${compteurHoraire}_id`;
                    console.debug(`Select statut configuré: name=${el.name}, id=${el.id}`);
                }

                // Configuration des labels
                if (el.tagName === 'LABEL') {
                    const text = el.innerText.toLowerCase();
                    const mappings = {
                        'date': `date_id_${compteurHoraire}`,
                        'debut': `debut${compteurHoraire}_id`,
                        'fin': `fin${compteurHoraire}_id`,
                        'contenu': `contenu${compteurHoraire}_id`,
                        'statut': `statut${compteurHoraire}_id`
                    };
                    
                    for (const [key, value] of Object.entries(mappings)) {
                        if (text.includes(key)) {
                            el.setAttribute('for', value);
                            console.debug(`Label "${key}" configuré: for=${value}`);
                            break;
                        }
                    }
                }
            });

            // Configuration spécifique du champ contenu
            const contenu = clone.querySelector('input.form-control:not(.form-control-date):not(.form-control-heure)');
            if (contenu) {
                contenu.name = `contenu${compteurHoraire}`;
                contenu.id = `contenu${compteurHoraire}_id`;
                contenu.value = '';
                console.debug(`Champ contenu configuré: name=${contenu.name}, id=${contenu.id}`);
            }

            // Configuration du bouton de suppression
            const boutonSuppression = clone.querySelector('.btn-supprimer');
            if (boutonSuppression) {
                boutonSuppression.setAttribute('onclick', `supprimerDiv('${cloneId}')`);
                console.debug(`Bouton suppression configuré pour l'élément #${cloneId}`);
            }

            // Insertion du nouvel élément dans le DOM
            const boutonAjout = document.getElementById('bouton_ajout_div');
            if (boutonAjout) {
                const actions = boutonAjout.closest('.d-flex');
                if (actions && actions.parentNode) {
                    actions.parentNode.insertBefore(clone, actions);
                    console.info(`Nouvel horaire #${compteurHoraire} ajouté avec succès`);
                }
            }

            // Initialisation du date picker Pikaday
            const dateInput = clone.querySelector('.form-control-date');
            if (dateInput && typeof Pikaday !== 'undefined') {
                console.debug('Initialisation du date picker...');
                let ignoreNextBlur = false;

                const picker = new Pikaday({
                    field: dateInput,
                    format: 'DD/MM/YYYY',
                    i18n: {
                        previousMonth: 'Mois précédent',
                        nextMonth: 'Mois suivant',
                        months: ['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'],
                        weekdays: ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'],
                        weekdaysShort: ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam']
                    },
                    onSelect: function (date) {
                        const jour = String(date.getDate()).padStart(2, '0');
                        const mois = String(date.getMonth() + 1).padStart(2, '0');
                        dateInput.value = `${jour}/${mois}/${date.getFullYear()}`;
                        ignoreNextBlur = true;
                        setTimeout(() => {
                            dateInput.focus();
                            dateInput.select();
                        }, 10);
                        console.debug('Date sélectionnée:', dateInput.value);
                    },
                    onClose: function () {
                        setTimeout(() => {
                            ignoreNextBlur = false;
                        }, 100);
                    }
                });

                dateInput.addEventListener('blur', function (e) {
                    if (ignoreNextBlur) {
                        e.preventDefault();
                        e.stopPropagation();
                        setTimeout(() => {
                            this.focus();
                        }, 10);
                    }
                });
            }

            // Initialisation du masque de saisie pour les heures
            console.debug('Initialisation des champs heure...');
            clone.querySelectorAll('.form-control-heure').forEach(input => {
                if (typeof Inputmask !== 'undefined') {
                    Inputmask("99:99", {
                        placeholder: "HH:MM",
                        insertMode: false,
                        showMaskOnHover: false
                    }).mask(input);

                    input.addEventListener('blur', function () {
                        const timeValue = this.value;
                        const isValid = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(timeValue);
                        
                        if (timeValue && !isValid) {
                            this.classList.add('is-invalid');
                            console.warn(`Format heure invalide: ${timeValue}`);
                        } else {
                            this.classList.remove('is-invalid');
                            console.debug(`Format heure valide: ${timeValue}`);
                        }
                    });
                }
            });

        } catch (error) {
            console.error('Erreur lors de l\'ajout d\'un horaire:', error);
        } finally {
            console.groupEnd();
        }
    }
</script>
<script>
    
    /**
     * Supprime un élément du DOM par son ID
     * @param {string} id - L'ID de l'élément à supprimer
     */
    function supprimerDiv(id) {
        console.debug(`Tentative de suppression de l'élément #${id}`);
        const div = document.getElementById(id);
        if (div) {
            div.remove();
            console.info(`Élément #${id} supprimé avec succès`);
        } else {
            console.warn(`Élément #${id} non trouvé - suppression ignorée`);
        }
    }
</script>
<script>
    /**
     * Compteur global pour les horaires ajoutés dynamiquement
     * Initialisé avec le nombre d'éléments .ajout-horaire existants
     */
    let compteurHoraire = document.querySelectorAll('.ajout-horaire').length;
    console.debug(`Initialisation - compteurHoraire: ${compteurHoraire}`);
</script>
<script>
    

    function hideError() {
        const errorContainer = document.getElementById('error-container');
        if (errorContainer) {
            errorContainer.style.display = 'none';
        }
    }

    function showError(message) {
        let errorContainer = document.getElementById('error-container');
        if (!errorContainer) {
            errorContainer = document.createElement('div');
            errorContainer.id = 'error-container';
            errorContainer.className = 'alert alert-danger mb-3';
            document.querySelector('form').prepend(errorContainer);
        }
        
        errorContainer.textContent = message;
        errorContainer.style.display = 'block';
    }
</script>
<script>
    
    /**
     * Met à jour le prix en fonction des sélections actuelles
     */
    async function updatePrixFromSelections() {
        const format = document.getElementById('format_id').value;
        const matiere = document.getElementById('matiere_id').value;
        const niveau = document.getElementById('niveau_id').value;
        
        // Vérifier que tous les champs sont remplis
        if (!format || !matiere || !niveau) {
            return;
        }
        
        try {
            const response = await fetch('/accounts/get_prix_cours_email/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    format: format,
                    matiere: matiere,
                    niveau: niveau
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Erreur lors de la récupération du prix');
            }

            const data = await response.json();
            
            if (data.prix_heure) {
                document.getElementById('prix_heure_id').value = data.prix_heure;
                hideError();
            } else {
                throw new Error('Prix non configuré pour cette combinaison');
            }
            
        } catch (error) {
            showError(error.message);
            document.getElementById('prix_heure_id').value = '';
        }
    }
</script>
<script>
// très important pour activer les fonctionnalités des paramètre du cours
// ce code doit être mis à la fin du JS
    window.addEventListener('DOMContentLoaded', () => {
        updatePrixFromSelections();
    });
</script>

{% endblock %}