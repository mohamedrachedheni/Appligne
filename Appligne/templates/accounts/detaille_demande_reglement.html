{% extends 'base.html' %}
{% load static %}
{% block title %}Détail demande de règlement | {{ block.super }}{% endblock %}

{% block content %}

<!-- Main Container -->
<div class="container-fluid teacher-dashboard">
    <div class="row g-0">
        <!-- Sidebar Column -->
        <div class="col-lg-2 sidebar-col d-none d-lg-block">
            {% include 'partials/_sidebar.html' %}
        </div>

        <!-- Main Content Column -->
        <div class="col-12 col-lg-10 main-content-col px-5">
            <div class="container-fluid py-4">
                <!-- Page Header -->
                
                    <div class="d-flex justify-content-between align-items-center py-4">
                        
                        <div class="status-badge">
                            <span class="badge bg-{% if demande_paiement.statut_demande == 'En attente' %}warning text-dark{% elif demande_paiement.statut_demande == 'En cours' %}info{% elif demande_paiement.statut_demande == 'Réglée' %}success{% elif demande_paiement.statut_demande == 'Annulée' %}secondary{% else %}primary{% endif %}">
                                {{ demande_paiement.statut_demande }}
                            </span>
                        </div>
                    </div>
                

                <!-- Alerts Section -->
                {% include 'partials/_alerts.html' %}

                <!-- Main Form -->
                <form method="POST" enctype="multipart/form-data" autocomplete="off" class="modern-form">
                    {% csrf_token %}

                    <!-- Student & Parent Info Card -->
                    <div class="card info-card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h3 class="card-title mb-0">
                                <i class="fas fa-user-graduate me-2"></i>Informations élève & parent
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <!-- Student Info -->
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <div class="info-label">
                                            <i class="fas fa-user me-2"></i>Élève
                                        </div>
                                        <div class="info-content">
                                            <h5>{{ eleve.user.last_name }} {{ eleve.user.first_name }}</h5>
                                            <div class="contact-info">
                                                <span><i class="fas fa-phone me-1"></i> {{ eleve.numero_telephone }}</span>
                                                <span><i class="fas fa-map-marker-alt me-1"></i> {{ eleve.adresse }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Parent Info -->
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <div class="info-label">
                                            <i class="fas fa-user-friends me-2"></i>Parent
                                        </div>
                                        <div class="info-content">
                                            <h5>{{ parent.prenom_parent }} {{ parent.nom_parent }}</h5>
                                            <div class="contact-info">
                                                <span><i class="fas fa-phone me-1"></i> {{ parent.telephone_parent }}</span>
                                                <span><i class="fas fa-envelope me-1"></i> {{ parent.email_parent }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Details Card -->
                    <div class="card info-card mb-4">
                        <div class="card-header bg-info text-white">
                            <h3 class="card-title mb-0">
                                <i class="fas fa-money-bill-wave me-2"></i>Détails du paiement
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="payment-detail">
                                        <div class="detail-label">Montant total</div>
                                        <div class="detail-value">{{ demande_paiement.montant }} €</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="payment-detail">
                                        <div class="detail-label">Date de création</div>
                                        <div class="detail-value">{{ demande_paiement.date_creation }}</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="payment-detail">
                                        <div class="detail-label">Statut du paiement</div>
                                        <div class="detail-value">
                                            {% if demande_paiement.payment_id %}
                                                <span class="text-success"><i class="fas fa-check-circle me-1"></i> Effectué</span>
                                            {% else %}
                                                <span class="text-warning"><i class="fas fa-clock me-1"></i> En attente</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Courses Details Card -->
                    <div class="card info-card mb-4">
                        <div class="card-header bg-light text-white">
                            <h3 class="card-title mb-0">
                                <i class="fas fa-book me-2"></i>Cours déclarés
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="accordion" id="coursesAccordion">
                                {% for enr_cours in cours_declares %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="false" aria-controls="collapse{{ forloop.counter }}">
                                            <i class="fas fa-book-open me-2"></i>
                                            {{ enr_cours.cours.matiere }} - {{ enr_cours.cours.niveau }} ({{ enr_cours.cours.format_cours }})
                                        </button>
                                    </h2>
                                    <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse" aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#coursesAccordion">
                                        <div class="accordion-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Date</th>
                                                            <th>Heure</th>
                                                            <th>Durée</th>
                                                            <th>Prix</th>
                                                            <th>Statut</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for enr_detaille in detaille_declares %}
                                                            {% if enr_cours.cours.id == enr_detaille.enr.cours.id %}
                                                            <tr>
                                                                <td>{{ enr_detaille.enr.horaire.date_cours }}</td>
                                                                <td>{{ enr_detaille.enr.horaire.heure_debut }} - {{ enr_detaille.enr.horaire.heure_fin }}</td>
                                                                <td>{{ enr_detaille.enr.horaire.duree }}</td>
                                                                <td>{{ enr_detaille.enr.prix_heure }} €</td>
                                                                <td>
                                                                    <span class="badge bg-{% if enr_detaille.enr.horaire.statut_cours == 'Terminé' %}success{% else %}warning text-dark{% endif %}">
                                                                        {{ enr_detaille.enr.horaire.statut_cours }}
                                                                    </span>
                                                                </td>
                                                            </tr>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Messages Section -->
                    <div class="row g-4">
                        <!-- Teacher Message -->
                        <div class="col-lg-6">
                            <div class="card message-card">
                                <div class="card-header bg-primary text-white">
                                    <h3 class="card-title mb-0">
                                        <i class="fas fa-paper-plane me-2"></i>Votre message
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div class="message-header">
                                        <h5>{{ email.sujet }}</h5>
                                        <div class="message-date">Envoyé le {{ email.date_creation }}</div>
                                    </div>
                                    <div class="message-content">
                                        {{ email.text_email|linebreaks }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Student Response -->
                        <div class="col-lg-6">
                            <div class="card message-card">
                                <div class="card-header bg-info text-white">
                                    <h3 class="card-title mb-0">
                                        <i class="fas fa-reply me-2"></i>Réponse de l'élève
                                    </h3>
                                </div>
                                <div class="card-body">
                                    {% if email_eleve.text_email %}
                                        <div class="message-header">
                                            <h5>{% if email_eleve.sujet %}{{ email_eleve.sujet }}{% else %}Pas d'objet{% endif %}</h5>
                                            <div class="message-date">Reçu le {{ email_eleve.date_creation }}</div>
                                        </div>
                                        <div class="message-content">
                                            {{ email_eleve.text_email|linebreaks }}
                                        </div>
                                    {% else %}
                                        <div class="no-response">
                                            <i class="fas fa-envelope-open-text fa-3x mb-3"></i>
                                            <h5>Aucune réponse reçue</h5>
                                            <p>L'élève n'a pas encore répondu à votre demande</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons mt-5">
                        <div class="d-flex justify-content-between">
                            <div>
                                <a href="{% url 'liste_declaration_cours' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Retour à la liste
                                </a>
                            </div>
                            <div>
                                {% if demande_paiement.statut_demande == 'En attente' %}
                                <button type="submit" class="btn btn-warning me-2" name="btn_rappelle">
                                    <i class="fas fa-bell me-2"></i>Envoyer un rappel
                                </button>
                                <button type="submit" class="btn btn-danger me-2" name="btn_annuler">
                                    <i class="fas fa-times-circle me-2"></i>Annuler la déclaration
                                </button>
                                {% endif %}
                                
                                {% if email_eleve.id %}
                                <button type="submit" class="btn btn-primary me-2" name="btn_repondre">
                                    <i class="fas fa-reply me-2"></i>Répondre
                                </button>
                                {% endif %}
                                
                                {% if demande_paiement.reclamation.id %}
                                <button type="submit" class="btn btn-warning" name="btn_reclamation">
                                    <i class="fas fa-exclamation-triangle me-2"></i>Voir la réclamation
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Back to Top -->
<a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top">
    <i class="fas fa-arrow-up"></i>
</a>

{% endblock %}

{% block javascript %}
<style>
    /* Modern Dashboard Styles */
    .teacher-dashboard {
        background-color: #f8f9fa;
        min-height: 100vh;
    }
    
    .sidebar-col {
        background: linear-gradient(180deg, #2c3e50 0%, #1a252f 100%);
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    
    .main-content-col {
        padding: 20px;
    }
    
    .page-header {
        padding: 20px 0;
        border-bottom: 1px solid #eee;
    }
    
    .page-title {
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }
    
    .status-badge .badge {
        font-size: 1rem;
        padding: 0.5rem 1rem;
        border-radius: 50px;
    }
    
    /* Card Styles */
    .info-card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        overflow: hidden;
        margin-bottom: 25px;
    }
    
    .info-card .card-header {
        padding: 15px 20px;
        border-bottom: none;
    }
    
    .info-card .card-body {
        padding: 25px;
    }
    
    /* Info Item Styles */
    .info-item {
        display: flex;
        margin-bottom: 15px;
    }
    
    .info-label {
        width: 120px;
        font-weight: 600;
        color: #6c757d;
    }
    
    .info-content h5 {
        font-weight: 600;
        margin-bottom: 5px;
        color: #2c3e50;
    }
    
    .contact-info span {
        display: block;
        margin-bottom: 3px;
        color: #6c757d;
    }
    
    /* Payment Detail Styles */
    .payment-detail {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        height: 100%;
    }
    
    .detail-label {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 5px;
    }
    
    .detail-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
    }
    
    /* Accordion Styles */
    .accordion-item {
        border: 1px solid #eee;
        border-radius: 8px;
        margin-bottom: 10px;
        overflow: hidden;
    }
    
    .accordion-button {
        font-weight: 500;
        padding: 15px 20px;
    }
    
    .accordion-button:not(.collapsed) {
        background-color: rgba(40, 167, 69, 0.1);
        color: #28a745;
    }
    
    /* Message Card Styles */
    .message-card {
        height: 100%;
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }
    
    .message-card .card-header {
        padding: 15px 20px;
        border-bottom: none;
    }
    
    .message-header {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    
    .message-header h5 {
        font-weight: 600;
        color: #2c3e50;
    }
    
    .message-date {
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    .message-content {
        line-height: 1.6;
        color: #495057;
    }
    
    .no-response {
        text-align: center;
        padding: 30px 0;
        color: #6c757d;
    }
    
    /* Action Buttons */
    .action-buttons {
        padding: 20px 0;
        border-top: 1px solid #eee;
    }
    
    /* Responsive Adjustments */
    @media (max-width: 992px) {
        .sidebar-col {
            display: none;
        }
        
        .main-content-col {
            padding: 15px;
        }
    }
    
    @media (max-width: 768px) {
        .info-item {
            flex-direction: column;
        }
        
        .info-label {
            width: 100%;
            margin-bottom: 5px;
        }
        
        .action-buttons .d-flex {
            flex-direction: column;
        }
        
        .action-buttons .btn {
            width: 100%;
            margin-bottom: 10px;
        }
    }
</style>

<script>
    // Function to adjust textarea height
    function adjustTextareaHeight() {
        const textareas = document.querySelectorAll('.message-content');
        
        textareas.forEach(textarea => {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        });
    }
    
    // Initialize on load and on content changes
    window.addEventListener('load', adjustTextareaHeight);
    window.addEventListener('resize', adjustTextareaHeight);
    
    // Initialize Bootstrap tooltips
    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
{% endblock %}